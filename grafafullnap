{
  "annotations": {
    "list": []
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "links": [],
  "panels": [
    {
      "title": "Karpenter Node Pools - Azure Auto-Provisioning Enabled",
      "type": "table",
      "targets": [
        {
          "expr": "sum(karpenter_nodes_created_total{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool) > 0",
          "legendFormat": "{{cluster}} - {{nodepool}}",
          "datasource": "${datasource}",
          "refId": "A",
          "instant": true
        },
        {
          "expr": "sum(karpenter_pods_state{cluster=~\"$cluster\", phase=\"Pending\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "Pending Pods",
          "datasource": "${datasource}",
          "refId": "B",
          "instant": true
        },
        {
          "expr": "sum(karpenter_nodes_created_total{cluster=~\"$cluster\", nodepool!=\"\"}) - sum(karpenter_nodes_terminated_total{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "Current Nodes",
          "datasource": "${datasource}",
          "refId": "C",
          "instant": true
        },
        {
          "expr": "sum(karpenter_nodeclaims_disrupted_total{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "Disrupted NodeClaims",
          "datasource": "${datasource}",
          "refId": "D",
          "instant": true
        },
        {
          "expr": "sum(karpenter_voluntary_disruption_eligible_nodes{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "Eligible for Disruption",
          "datasource": "${datasource}",
          "refId": "E",
          "instant": true
        },
        {
          "expr": "sum(karpenter_voluntary_disruption_decisions_total{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "Disruption Decisions",
          "datasource": "${datasource}",
          "refId": "F",
          "instant": true
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto", "displayMode": "auto" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green" }, { "color": "red", "value": 10 }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Pending Pods" }, "properties": [{ "id": "thresholds", "value": { "steps": [{ "color": "red", "value": 10 }] } }] },
          { "matcher": { "id": "byName", "options": "Disrupted NodeClaims" }, "properties": [{ "id": "thresholds", "value": { "steps": [{ "color": "red", "value": 10 }] } }] }
        ]
      },
      "options": { "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Current Nodes" }] },
      "transformations": [
        {
          "id": "organize",
          "options": {
            "indexByName": { "cluster": 0, "nodepool": 1, "Value #B": 2, "Value #C": 3, "Value #D": 4, "Value #E": 5, "Value #F": 6 },
            "renameByName": {
              "Value #B": "Pending Pods",
              "Value #C": "Current Nodes",
              "Value #D": "Disrupted NodeClaims",
              "Value #E": "Eligible for Disruption",
              "Value #F": "Disruption Decisions"
            }
          }
        },
        { "id": "filterByValue", "options": { "filters": [{ "fieldName": "Current Nodes", "config": { "id": "greater", "options": { "value": 0 } } }] } }
      ],
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 }
    },
    {
      "title": "Pending Pods vs. Node Creation Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "sum(karpenter_pods_state{cluster=~\"$cluster\", phase=\"Pending\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Pending Pods",
          "datasource": "${datasource}",
          "refId": "A"
        },
        {
          "expr": "rate(karpenter_nodes_created_total{cluster=~\"$cluster\", nodepool!=\"\"}[5m]) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Creation Rate",
          "datasource": "${datasource}",
          "refId": "B"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "lines", "fillOpacity": 10 },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green" }, { "color": "red", "value": 10 }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Pending Pods" }, "properties": [{ "id": "unit", "value": "none" }] },
          { "matcher": { "id": "byName", "options": "Creation Rate" }, "properties": [{ "id": "unit", "value": "nodes/s" }, { "id": "custom.axisPlacement", "value": "right" }] }
        ]
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 }
    },
    {
      "title": "Node Creation vs. Termination Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(karpenter_nodes_created_total{cluster=~\"$cluster\", nodepool!=\"\"}[5m]) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Creation Rate",
          "datasource": "${datasource}",
          "refId": "A"
        },
        {
          "expr": "rate(karpenter_nodes_terminated_total{cluster=~\"$cluster\", nodepool!=\"\"}[5m]) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Termination Rate",
          "datasource": "${datasource}",
          "refId": "B"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "lines", "fillOpacity": 10 },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green" }, { "color": "red", "value": 0.1 }] },
          "unit": "nodes/s"
        }
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 }
    },
    {
      "title": "Nodes Pending Disruption Due to PDB",
      "type": "table",
      "targets": [
        {
          "expr": "sum(karpenter_voluntary_disruption_eligible_nodes{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool) unless sum(increase(karpenter_voluntary_disruption_decisions_total{cluster=~\"$cluster\", nodepool!=\"\"}[5m])) by (cluster, nodepool) > 0",
          "legendFormat": "{{cluster}} - {{nodepool}} - Eligible Nodes",
          "datasource": "${datasource}",
          "refId": "A",
          "instant": true
        },
        {
          "expr": "sum(karpenter_pods_state{cluster=~\"$cluster\", phase=\"Pending\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Pending Pods",
          "datasource": "${datasource}",
          "refId": "B",
          "instant": true
        },
        {
          "expr": "sum(increase(karpenter_nodeclaims_disrupted_total{cluster=~\"$cluster\", nodepool!=\"\"}[5m])) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Disruptions Completed",
          "datasource": "${datasource}",
          "refId": "C",
          "instant": true
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto", "displayMode": "auto" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green" }, { "color": "red", "value": 1 }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Eligible Nodes" }, "properties": [{ "id": "thresholds", "value": { "steps": [{ "color": "red", "value": 1 }] } }] },
          { "matcher": { "id": "byName", "options": "Pending Pods" }, "properties": [{ "id": "thresholds", "value": { "steps": [{ "color": "red", "value": 10 }] } }] }
        ]
      },
      "options": { "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Eligible Nodes" }] },
      "transformations": [
        {
          "id": "organize",
          "options": {
            "indexByName": { "cluster": 0, "nodepool": 1, "Value #A": 2, "Value #B": 3, "Value #C": 4 },
            "renameByName": {
              "Value #A": "Eligible Nodes",
              "Value #B": "Pending Pods",
              "Value #C": "Disruptions (5m)"
            }
          }
        },
        { "id": "filterByValue", "options": { "filters": [{ "fieldName": "Eligible Nodes", "config": { "id": "greater", "options": { "value": 0 } } }] } }
      ],
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 24 }
    },
    {
      "title": "Karpenter Disruption Activity Trends",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(karpenter_nodeclaims_disrupted_total{cluster=~\"$cluster\", nodepool!=\"\", reason!~\"\"}[5m]) by (cluster, nodepool, reason)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Disruption ({{reason}})",
          "datasource": "${datasource}",
          "refId": "A"
        },
        {
          "expr": "sum(karpenter_voluntary_disruption_eligible_nodes{cluster=~\"$cluster\", nodepool!=\"\"}) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Eligible Nodes",
          "datasource": "${datasource}",
          "refId": "B"
        },
        {
          "expr": "rate(karpenter_voluntary_disruption_decisions_total{
cluster=~\"$cluster\", nodepool!=\"\"}[5m]) by (cluster, nodepool)",
          "legendFormat": "{{cluster}} - {{nodepool}} - Disruption Decisions",
          "datasource": "${datasource}",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "lines", "fillOpacity": 10 },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green" }, { "color": "red", "value": 0.1 }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Eligible Nodes" }, "properties": [{ "id": "unit", "value": "none" }, { "id": "custom.axisPlacement", "value": "left" }] },
          { "matcher": { "id": "byRegexp", "options": "Disruption.*" }, "properties": [{ "id": "unit", "value": "ops/s" }, { "id": "custom.axisPlacement", "value": "right" }] }
        ]
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 32 }
    }
  ],
  "schemaVersion": 36,
  "style": "dark",
  "tags": ["karpenter", "aks", "auto-provisioning"],
  "templating": {
    "list": [
      {
        "current": {},
        "hide": 0,
        "includeAll": false,
        "label": "Data Source",
        "multi": false,
        "name": "datasource",
        "options": [],
        "query": "prometheus",
        "queryValue": "",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "type": "datasource"
      },
      {
        "current": {},
        "hide": 0,
        "includeAll": true,
        "label": "Cluster",
        "multi": false,
        "name": "cluster",
        "options": [],
        "query": "label_values(karpenter_nodes_created_total{nodepool!=\"\"}, cluster)",
        "queryValue": "",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "type": "query",
        "datasource": "${datasource}"
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {},
  "timezone": "Asia/Kolkata",
  "title": "Karpenter Auto-Provisioning Dashboard for AKS",
  "uid": "karpenter-aks-autoprovisioning",
  "version": 1
}
